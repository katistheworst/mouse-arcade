<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Breathe ğŸŒ¸</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg1: #0a0a1a;
    --bg2: #0f0f2e;
    --orb1: #7b4fa6;
    --orb2: #a06ecc;
    --orb3: #c4a4e8;
    --glow: rgba(160, 110, 204, 0.35);
    --text: #e8d5ff;
    --accent: #c4a4e8;
    --dim: rgba(200, 170, 230, 0.5);
  }

  body {
    min-height: 100vh;
    background: radial-gradient(ellipse at 50% 40%, var(--bg2) 0%, var(--bg1) 100%);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-family: 'Georgia', serif;
    color: var(--text);
    overflow: hidden;
    transition: background 1.5s ease;
    user-select: none;
  }

  /* â”€â”€â”€â”€â”€ Stars â”€â”€â”€â”€â”€ */
  #stars { position: fixed; inset: 0; pointer-events: none; z-index: 0; }

  /* â”€â”€â”€â”€â”€ Main layout â”€â”€â”€â”€â”€ */
  .container {
    position: relative;
    z-index: 10;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 32px;
    padding: 24px;
  }

  /* â”€â”€â”€â”€â”€ Orb area â”€â”€â”€â”€â”€ */
  .orb-wrap {
    position: relative;
    width: 280px;
    height: 280px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Outer pulse ring */
  .ring {
    position: absolute;
    border-radius: 50%;
    border: 1px solid var(--orb1);
    opacity: 0;
    transform: scale(0.6);
    transition: none;
  }
  .ring1 { width: 100%; height: 100%; }
  .ring2 { width: 120%; height: 120%; }
  .ring3 { width: 140%; height: 140%; }

  /* Soft glow base */
  .glow-base {
    position: absolute;
    width: 200px; height: 200px;
    border-radius: 50%;
    background: radial-gradient(circle, var(--glow) 0%, transparent 70%);
    filter: blur(20px);
    transition: transform 0.3s ease, opacity 0.3s ease;
  }

  /* Main orb */
  .orb {
    width: 120px; height: 120px;
    border-radius: 50%;
    background: radial-gradient(circle at 38% 35%, var(--orb3), var(--orb1) 70%, #3a1a5c);
    box-shadow:
      0 0 30px var(--glow),
      0 0 60px rgba(123, 79, 166, 0.2),
      inset 0 0 20px rgba(255,255,255,0.08);
    transition: transform 0.1s linear, box-shadow 0.5s ease;
    cursor: pointer;
    position: relative;
  }

  .orb::after {
    content: '';
    position: absolute;
    top: 20%; left: 20%;
    width: 25%; height: 25%;
    border-radius: 50%;
    background: rgba(255,255,255,0.18);
    filter: blur(3px);
  }

  /* â”€â”€â”€â”€â”€ Phase label â”€â”€â”€â”€â”€ */
  .phase-label {
    font-size: 1.6rem;
    font-weight: 300;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--accent);
    min-height: 2.4rem;
    text-align: center;
    transition: opacity 0.4s ease;
  }

  .phase-count {
    font-size: 2.4rem;
    font-weight: 300;
    color: var(--text);
    min-height: 3rem;
    text-align: center;
    font-family: 'Georgia', serif;
    opacity: 0.9;
    transition: opacity 0.3s ease;
  }

  .phase-sub {
    font-size: 0.85rem;
    color: var(--dim);
    letter-spacing: 0.08em;
    text-align: center;
    min-height: 1.2rem;
  }

  /* â”€â”€â”€â”€â”€ Controls â”€â”€â”€â”€â”€ */
  .controls {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 18px;
    width: 100%;
    max-width: 360px;
  }

  /* Pattern selector */
  .pattern-row {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: center;
  }

  .pat-btn {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(196, 164, 232, 0.2);
    border-radius: 20px;
    color: var(--dim);
    padding: 6px 14px;
    font-size: 0.78rem;
    letter-spacing: 0.05em;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: inherit;
  }

  .pat-btn:hover { background: rgba(196, 164, 232, 0.12); color: var(--accent); }
  .pat-btn.active {
    background: rgba(196, 164, 232, 0.18);
    border-color: var(--accent);
    color: var(--accent);
  }

  /* Theme dots */
  .theme-row {
    display: flex;
    gap: 12px;
    justify-content: center;
  }

  .theme-dot {
    width: 20px; height: 20px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid transparent;
    transition: transform 0.2s ease, border-color 0.2s ease;
  }
  .theme-dot:hover { transform: scale(1.2); }
  .theme-dot.active { border-color: white; transform: scale(1.15); }
  .dot-amethyst { background: linear-gradient(135deg, #7b4fa6, #c4a4e8); }
  .dot-ocean    { background: linear-gradient(135deg, #0d6e8c, #6ec6e8); }
  .dot-sunset   { background: linear-gradient(135deg, #9e3060, #f4a261); }
  .dot-forest   { background: linear-gradient(135deg, #1a5c3a, #6ecf8a); }

  /* Action buttons */
  .btn-row { display: flex; gap: 14px; }

  .btn-start {
    padding: 12px 40px;
    background: linear-gradient(135deg, var(--orb1), var(--orb2));
    border: none;
    border-radius: 30px;
    color: white;
    font-size: 1rem;
    letter-spacing: 0.08em;
    cursor: pointer;
    font-family: inherit;
    box-shadow: 0 4px 20px rgba(123, 79, 166, 0.4);
    transition: all 0.2s ease;
  }
  .btn-start:hover { transform: scale(1.04); box-shadow: 0 6px 30px rgba(123, 79, 166, 0.5); }
  .btn-start:active { transform: scale(0.98); }

  .btn-sound {
    padding: 12px 18px;
    background: rgba(255,255,255,0.07);
    border: 1px solid rgba(196, 164, 232, 0.25);
    border-radius: 30px;
    color: var(--dim);
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .btn-sound:hover { background: rgba(255,255,255,0.12); color: var(--accent); }
  .btn-sound.on { color: var(--accent); border-color: var(--accent); }

  /* Stats */
  .stats {
    display: flex;
    gap: 28px;
    font-size: 0.8rem;
    color: var(--dim);
    letter-spacing: 0.06em;
  }
  .stat-val { color: var(--accent); font-size: 1.1rem; display: block; text-align: center; }

  /* Pattern info */
  .pattern-info {
    font-size: 0.78rem;
    color: var(--dim);
    text-align: center;
    min-height: 1.1rem;
  }

  /* Progress arc */
  #arc-canvas {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    pointer-events: none;
  }

  /* Particles */
  #particle-canvas {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 1;
  }

  /* Idle text */
  .idle-text {
    font-size: 0.88rem;
    color: var(--dim);
    letter-spacing: 0.06em;
    text-align: center;
    opacity: 0.7;
  }
</style>
</head>
<body>

<canvas id="stars"></canvas>
<canvas id="particle-canvas"></canvas>

<div class="container">
  <!-- Orb -->
  <div class="orb-wrap">
    <div class="ring ring1" id="r1"></div>
    <div class="ring ring2" id="r2"></div>
    <div class="ring ring3" id="r3"></div>
    <div class="glow-base" id="glowBase"></div>
    <div class="orb" id="orb"></div>
    <canvas id="arc-canvas" width="320" height="320"></canvas>
  </div>

  <!-- Phase display -->
  <div class="phase-label" id="phaseLabel">â€”</div>
  <div class="phase-count" id="phaseCount">  </div>
  <div class="phase-sub" id="phaseSub">tap to begin</div>

  <!-- Controls -->
  <div class="controls">
    <div class="pattern-row" id="patternRow"></div>
    <div class="pattern-info" id="patternInfo"></div>

    <div class="btn-row">
      <button class="btn-start" id="btnStart">Begin</button>
      <button class="btn-sound" id="btnSound">ğŸ”•</button>
    </div>

    <div class="theme-row">
      <div class="theme-dot dot-amethyst active" data-theme="amethyst" title="Amethyst"></div>
      <div class="theme-dot dot-ocean" data-theme="ocean" title="Ocean"></div>
      <div class="theme-dot dot-sunset" data-theme="sunset" title="Sunset"></div>
      <div class="theme-dot dot-forest" data-theme="forest" title="Forest"></div>
    </div>

    <div class="stats">
      <div><span class="stat-val" id="statBreaths">0</span>breaths</div>
      <div><span class="stat-val" id="statTime">0:00</span>session</div>
      <div><span class="stat-val" id="statCycles">0</span>cycles</div>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THEMES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const THEMES = {
  amethyst: {
    bg1: '#0a0a1a', bg2: '#0f0f2e',
    orb1: '#7b4fa6', orb2: '#a06ecc', orb3: '#c4a4e8',
    glow: 'rgba(160,110,204,0.35)',
    text: '#e8d5ff', accent: '#c4a4e8', dim: 'rgba(200,170,230,0.5)',
    arcInhale: '#c4a4e8', arcHold: '#f0e0ff', arcExhale: '#8060b0',
    toneFq: [174, 285, 396] // binaural-ish frequencies
  },
  ocean: {
    bg1: '#020d14', bg2: '#031929',
    orb1: '#0d5e7c', orb2: '#1a90b8', orb3: '#6ecfe8',
    glow: 'rgba(30,144,188,0.35)',
    text: '#d0f0ff', accent: '#6ecfe8', dim: 'rgba(110,207,232,0.5)',
    arcInhale: '#6ecfe8', arcHold: '#b0eeff', arcExhale: '#1a90b8',
    toneFq: [132, 264, 396]
  },
  sunset: {
    bg1: '#100810', bg2: '#200818',
    orb1: '#8b2252', orb2: '#c0406a', orb3: '#f4a0b0',
    glow: 'rgba(200,80,110,0.35)',
    text: '#ffe0e8', accent: '#f4a0b0', dim: 'rgba(244,160,176,0.5)',
    arcInhale: '#f4a0b0', arcHold: '#ffe4c0', arcExhale: '#c0406a',
    toneFq: [110, 220, 330]
  },
  forest: {
    bg1: '#030d06', bg2: '#071a0c',
    orb1: '#1a5c38', orb2: '#2e8c58', orb3: '#6ecf8a',
    glow: 'rgba(46,140,88,0.35)',
    text: '#d0fce0', accent: '#6ecf8a', dim: 'rgba(110,207,138,0.5)',
    arcInhale: '#6ecf8a', arcHold: '#b0ffd0', arcExhale: '#2e8c58',
    toneFq: [128, 256, 384]
  }
};

let theme = THEMES.amethyst;

function applyTheme(t) {
  theme = THEMES[t];
  const r = document.documentElement;
  r.style.setProperty('--bg1', theme.bg1);
  r.style.setProperty('--bg2', theme.bg2);
  r.style.setProperty('--orb1', theme.orb1);
  r.style.setProperty('--orb2', theme.orb2);
  r.style.setProperty('--orb3', theme.orb3);
  r.style.setProperty('--glow', theme.glow);
  r.style.setProperty('--text', theme.text);
  r.style.setProperty('--accent', theme.accent);
  r.style.setProperty('--dim', theme.dim);
  // update orb gradient
  document.getElementById('orb').style.background =
    `radial-gradient(circle at 38% 35%, ${theme.orb3}, ${theme.orb1} 70%, #1a0830)`;
  document.getElementById('orb').style.boxShadow =
    `0 0 30px ${theme.glow}, 0 0 60px ${theme.glow.replace('0.35','0.15')}, inset 0 0 20px rgba(255,255,255,0.08)`;
  // reInit stars
  drawStars();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PATTERNS  [inhale, holdIn, exhale, holdOut]
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PATTERNS = [
  { name: 'Box',     steps: [4,4,4,4],  info: '4-4-4-4 Â· focus & calm' },
  { name: '4-7-8',  steps: [4,7,8,0],  info: '4-7-8 Â· anxiety relief & sleep' },
  { name: 'Calm',   steps: [4,4,6,2],  info: '4-4-6-2 Â· stress release' },
  { name: 'Deep',   steps: [5,0,5,0],  info: '5-5 Â· simple deep breathing' },
  { name: 'Energize', steps:[6,2,4,0], info: '6-2-4 Â· energy & alertness' },
];

let patIdx = 0;
let running = false;
let soundOn = false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUDIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let audioCtx = null;
function getAudio() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}

function playTone(freq, type = 'sine', dur = 0.6, vol = 0.08) {
  if (!soundOn) return;
  const ctx = getAudio();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.connect(gain); gain.connect(ctx.destination);
  osc.type = type;
  osc.frequency.setValueAtTime(freq, ctx.currentTime);
  gain.gain.setValueAtTime(0, ctx.currentTime);
  gain.gain.linearRampToValueAtTime(vol, ctx.currentTime + 0.1);
  gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + dur);
  osc.start(ctx.currentTime);
  osc.stop(ctx.currentTime + dur);
}

function chime(phase) {
  const fqs = theme.toneFq;
  if (phase === 'inhale')  { playTone(fqs[0], 'sine', 1.2, 0.07); }
  if (phase === 'hold')    { playTone(fqs[1], 'sine', 0.4, 0.05); }
  if (phase === 'exhale')  { playTone(fqs[2], 'sine', 1.5, 0.07); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STARS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const starCanvas = document.getElementById('stars');
const sCtx = starCanvas.getContext('2d');
let stars = [];

function drawStars() {
  starCanvas.width = window.innerWidth;
  starCanvas.height = window.innerHeight;
  stars = [];
  for (let i = 0; i < 160; i++) {
    stars.push({
      x: Math.random() * starCanvas.width,
      y: Math.random() * starCanvas.height,
      r: Math.random() * 1.2 + 0.3,
      a: Math.random(),
      speed: Math.random() * 0.005 + 0.002,
      phase: Math.random() * Math.PI * 2
    });
  }
}

function animateStars(t) {
  sCtx.clearRect(0, 0, starCanvas.width, starCanvas.height);
  stars.forEach(s => {
    const blink = 0.3 + 0.7 * (0.5 + 0.5 * Math.sin(t * s.speed * 1000 + s.phase));
    sCtx.beginPath();
    sCtx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
    sCtx.fillStyle = theme.accent.replace(')', `,${blink * 0.9})`).replace('rgba', 'rgba').replace('rgb(', 'rgba(').replace('#', 'rgba(').includes('rgba') ? theme.accent : theme.accent;
    // simple: draw in white with variable alpha
    sCtx.fillStyle = `rgba(255,255,255,${blink * 0.7})`;
    sCtx.fill();
  });
  requestAnimationFrame(animateStars);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARTICLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const pCanvas = document.getElementById('particle-canvas');
const pCtx = pCanvas.getContext('2d');
let particles = [];

function resizePC() {
  pCanvas.width = window.innerWidth;
  pCanvas.height = window.innerHeight;
}

function spawnParticle(phase) {
  const cx = window.innerWidth / 2;
  const cy = window.innerHeight * 0.38;
  const angle = Math.random() * Math.PI * 2;
  const r = 100 + Math.random() * 20;
  const col = phase === 'inhale' ? theme.arcInhale :
              phase === 'exhale' ? theme.arcExhale : theme.arcHold;
  particles.push({
    x: cx + Math.cos(angle) * r,
    y: cy + Math.sin(angle) * r,
    vx: Math.cos(angle) * (phase === 'exhale' ? 0.6 : -0.5) * (0.5 + Math.random()),
    vy: Math.sin(angle) * (phase === 'exhale' ? 0.6 : -0.5) * (0.5 + Math.random()) - 0.4,
    life: 1,
    maxLife: 60 + Math.random() * 60,
    size: 1.2 + Math.random() * 1.8,
    color: col
  });
}

function animParticles() {
  pCtx.clearRect(0, 0, pCanvas.width, pCanvas.height);
  particles = particles.filter(p => p.life > 0);
  particles.forEach(p => {
    p.x += p.vx;
    p.y += p.vy;
    p.life -= 1 / p.maxLife;
    const a = Math.max(0, p.life) * 0.7;
    pCtx.beginPath();
    pCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
    pCtx.fillStyle = p.color + Math.round(a * 255).toString(16).padStart(2,'0');
    pCtx.fill();
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ARC CANVAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const arcCv = document.getElementById('arc-canvas');
const arcCtx = arcCv.getContext('2d');

function drawArc(progress, phase) {
  arcCtx.clearRect(0, 0, 320, 320);
  const cx = 160, cy = 160, r = 148;
  const startAngle = -Math.PI / 2;
  const endAngle = startAngle + progress * Math.PI * 2;

  // Background ring
  arcCtx.beginPath();
  arcCtx.arc(cx, cy, r, 0, Math.PI * 2);
  arcCtx.strokeStyle = 'rgba(255,255,255,0.05)';
  arcCtx.lineWidth = 2;
  arcCtx.stroke();

  if (progress <= 0) return;

  // Colored progress arc
  const col = phase === 'inhale' ? theme.arcInhale :
              phase === 'hold'   ? theme.arcHold   :
              phase === 'exhale' ? theme.arcExhale  : theme.arcHold;

  arcCtx.beginPath();
  arcCtx.arc(cx, cy, r, startAngle, endAngle);
  arcCtx.strokeStyle = col;
  arcCtx.lineWidth = 2.5;
  arcCtx.lineCap = 'round';
  arcCtx.shadowColor = col;
  arcCtx.shadowBlur = 8;
  arcCtx.stroke();
  arcCtx.shadowBlur = 0;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ORB ANIMATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const orb = document.getElementById('orb');
const glowBase = document.getElementById('glowBase');
const [r1,r2,r3] = ['r1','r2','r3'].map(id => document.getElementById(id));

function setOrbScale(s) {
  orb.style.transform = `scale(${s})`;
  glowBase.style.transform = `scale(${s * 1.3})`;
  glowBase.style.opacity = 0.3 + (s - 1) * 0.6;
}

function pulseRings() {
  [r1,r2,r3].forEach((r, i) => {
    setTimeout(() => {
      r.style.transition = 'transform 1.2s ease-out, opacity 1.2s ease-out';
      r.style.transform = 'scale(1.25)';
      r.style.opacity = '0.18';
      setTimeout(() => {
        r.style.transform = 'scale(0.6)';
        r.style.opacity = '0';
        r.style.transition = 'none';
      }, 1300);
    }, i * 180);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BREATHING ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const phaseNames = ['inhale', 'hold', 'exhale', 'hold'];
const phaseLabels = ['Inhale', 'Hold', 'Exhale', 'Hold'];

let currentPhaseIdx = 0;
let timer = null;
let phaseStart = 0;
let phaseDuration = 0;
let breathCount = 0;
let cycleCount = 0;
let sessionStart = 0;
let animFrameId = null;

const phaseLabel = document.getElementById('phaseLabel');
const phaseCount = document.getElementById('phaseCount');
const phaseSub   = document.getElementById('phaseSub');
const btnStart   = document.getElementById('btnStart');

function startSession() {
  running = true;
  btnStart.textContent = 'Stop';
  sessionStart = Date.now();
  breathCount = 0; cycleCount = 0;
  updateStats();
  currentPhaseIdx = 0;
  startPhase();
  runLoop();
}

function stopSession() {
  running = false;
  btnStart.textContent = 'Begin';
  clearTimeout(timer);
  cancelAnimationFrame(animFrameId);
  phaseLabel.textContent = 'â€”';
  phaseCount.textContent = ' ';
  phaseSub.textContent = 'tap to begin';
  setOrbScale(1);
  drawArc(0, 'inhale');
}

function startPhase() {
  const pat = PATTERNS[patIdx];
  let dur = pat.steps[currentPhaseIdx];
  // skip zero-duration phases (e.g. 4-7-8 has no holdOut)
  while (dur === 0 && currentPhaseIdx < 3) {
    currentPhaseIdx = (currentPhaseIdx + 1) % 4;
    dur = pat.steps[currentPhaseIdx];
    if (currentPhaseIdx === 0) {
      cycleCount++;
      if (breathCount > 0) {/* already counted */}
    }
  }

  phaseDuration = dur * 1000;
  phaseStart = Date.now();
  const phaseName = phaseNames[currentPhaseIdx];
  phaseLabel.textContent = phaseLabels[currentPhaseIdx];
  chime(phaseName);

  if (phaseName === 'inhale') {
    breathCount++;
    updateStats();
    pulseRings();
  }
  if (currentPhaseIdx === 0) cycleCount++;

  timer = setTimeout(() => {
    currentPhaseIdx = (currentPhaseIdx + 1) % 4;
    if (!running) return;
    startPhase();
  }, phaseDuration);
}

function runLoop() {
  if (!running) return;
  const now = Date.now();
  const elapsed = now - phaseStart;
  const progress = Math.min(elapsed / phaseDuration, 1);
  const phaseName = phaseNames[currentPhaseIdx];

  // Count display
  const remaining = Math.ceil((phaseDuration - elapsed) / 1000);
  phaseCount.textContent = remaining <= 0 ? '' : remaining;

  // Orb scale
  let scale = 1;
  if (phaseName === 'inhale') scale = 1 + progress * 0.45;
  else if (phaseName === 'exhale') scale = 1.45 - progress * 0.45;
  else scale = phaseName === 'hold' && currentPhaseIdx === 1 ? 1.45 : 1.0;
  setOrbScale(scale);

  // Arc
  drawArc(progress, phaseName);

  // Particles
  if (running && Math.random() < 0.25) spawnParticle(phaseName);

  // Sub text
  if      (phaseName === 'inhale')                    phaseSub.textContent = 'breathe in slowlyâ€¦';
  else if (phaseName === 'exhale')                    phaseSub.textContent = 'let it all goâ€¦';
  else if (currentPhaseIdx === 1)                     phaseSub.textContent = 'hold gentlyâ€¦';
  else                                                phaseSub.textContent = 'pauseâ€¦';

  animParticles();
  updateStats();
  animFrameId = requestAnimationFrame(runLoop);
}

function updateStats() {
  document.getElementById('statBreaths').textContent = breathCount;
  document.getElementById('statCycles').textContent = cycleCount;
  if (running) {
    const s = Math.floor((Date.now() - sessionStart) / 1000);
    const m = Math.floor(s / 60);
    const ss = (s % 60).toString().padStart(2,'0');
    document.getElementById('statTime').textContent = `${m}:${ss}`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PATTERN BUTTONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const patRow = document.getElementById('patternRow');
const patInfo = document.getElementById('patternInfo');

PATTERNS.forEach((p, i) => {
  const b = document.createElement('button');
  b.className = 'pat-btn' + (i === 0 ? ' active' : '');
  b.textContent = p.name;
  b.addEventListener('click', () => {
    if (running) { clearTimeout(timer); stopSession(); }
    patIdx = i;
    patRow.querySelectorAll('.pat-btn').forEach((bb,j) => bb.classList.toggle('active', j===i));
    patInfo.textContent = p.info;
  });
  patRow.appendChild(b);
});
patInfo.textContent = PATTERNS[0].info;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THEME DOTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.querySelectorAll('.theme-dot').forEach(dot => {
  dot.addEventListener('click', () => {
    document.querySelectorAll('.theme-dot').forEach(d => d.classList.remove('active'));
    dot.classList.add('active');
    if (running) stopSession();
    applyTheme(dot.dataset.theme);
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUTTONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
btnStart.addEventListener('click', () => {
  if (running) stopSession();
  else startSession();
});

document.getElementById('btnSound').addEventListener('click', function() {
  soundOn = !soundOn;
  this.textContent = soundOn ? 'ğŸ””' : 'ğŸ”•';
  this.classList.toggle('on', soundOn);
  if (soundOn) { getAudio(); audioCtx.resume(); }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('resize', () => {
  drawStars();
  resizePC();
});

drawStars();
resizePC();
requestAnimationFrame(animateStars);
setOrbScale(1);
drawArc(0, 'inhale');

// Update session timer even when stopped (just show 0:00)
setInterval(() => { if (running) updateStats(); }, 1000);
</script>
</body>
</html>
