<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ðŸ«™ Firefly Jar</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0a12; overflow: hidden; cursor: none; font-family: 'Georgia', serif; }
canvas { display: block; }
#cursor { position: fixed; width: 20px; height: 20px; border-radius: 50%; pointer-events: none; z-index: 100;
  background: radial-gradient(circle, rgba(255,240,180,0.6) 0%, transparent 70%); transform: translate(-50%,-50%); }
#ui { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 12px;
  opacity: 0; transition: opacity 0.5s; z-index: 10; }
body:hover #ui { opacity: 1; }
.btn { background: rgba(255,240,180,0.1); border: 1px solid rgba(255,240,180,0.2); color: #ffe8a0;
  padding: 8px 16px; border-radius: 20px; cursor: pointer; font-family: inherit; font-size: 13px;
  transition: all 0.3s; backdrop-filter: blur(4px); }
.btn:hover { background: rgba(255,240,180,0.2); border-color: rgba(255,240,180,0.4); }
.btn.active { background: rgba(255,240,180,0.25); border-color: rgba(255,240,180,0.5); }
#count { position: fixed; top: 16px; right: 20px; color: rgba(255,240,180,0.3); font-size: 12px;
  z-index: 10; opacity: 0; transition: opacity 0.5s; }
body:hover #count { opacity: 1; }
#toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); color: rgba(255,240,180,0.6);
  font-size: 16px; font-style: italic; z-index: 10; opacity: 0; transition: opacity 1s; pointer-events: none; }
</style>
</head>
<body>
<div id="cursor"></div>
<canvas id="c"></canvas>
<div id="count">âœ¨ <span id="num">0</span> fireflies</div>
<div id="ui">
  <button class="btn" onclick="addFireflies(5)" title="Release more">+ release 5</button>
  <button class="btn" id="tapBtn" onclick="toggleTap()" title="Tap glass">ðŸ«™ tap glass</button>
  <button class="btn" onclick="toggleLid()" id="lidBtn" title="Open/close lid">ðŸ”“ lid open</button>
  <button class="btn" onclick="cycleColor()" id="colorBtn" title="Change color">ðŸŸ¡ warm</button>
</div>
<div id="toast">tap the glass to startle them</div>
<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
let W, H, jarX, jarY, jarW, jarH, jarR;
const cursor = document.getElementById('cursor');
let mx = -100, my = -100;

const colorSchemes = [
  { name: 'warm', colors: ['#ffe066','#ffcc33','#ffdd77','#fff5cc'], glow: '#ffe066' },
  { name: 'cool', colors: ['#66eeff','#33ccdd','#88ffee','#aaffff'], glow: '#66eeff' },
  { name: 'firefly', colors: ['#88ff44','#66dd22','#aaff66','#ccff88'], glow: '#88ff44' },
  { name: 'magic', colors: ['#dd88ff','#bb55ee','#ee99ff','#ffaaff'], glow: '#cc77ff' },
];
let colorIdx = 0;
let scheme = colorSchemes[0];

let lidOpen = true;
let fireflies = [];
let escapedFireflies = [];
let particles = [];
let shakeOffset = { x: 0, y: 0 };
let shakeDecay = 0;

function resize() {
  W = canvas.width = window.innerWidth;
  H = canvas.height = window.innerHeight;
  jarH = H * 0.6;
  jarW = jarH * 0.45;
  jarX = W / 2;
  jarY = H / 2 + 20;
  jarR = jarW * 0.12;
}
resize();
window.addEventListener('resize', resize);

document.addEventListener('mousemove', e => { mx = e.clientX; my = e.clientY; cursor.style.left = mx+'px'; cursor.style.top = my+'px'; });

class Firefly {
  constructor(x, y, inJar = true) {
    this.x = x; this.y = y; this.inJar = inJar;
    this.vx = (Math.random() - 0.5) * 1.5;
    this.vy = (Math.random() - 0.5) * 1.5;
    this.size = 2 + Math.random() * 2;
    this.phase = Math.random() * Math.PI * 2;
    this.pulseSpeed = 0.02 + Math.random() * 0.03;
    this.color = scheme.colors[Math.floor(Math.random() * scheme.colors.length)];
    this.wanderAngle = Math.random() * Math.PI * 2;
    this.startled = 0;
    this.escaped = false;
    this.escapeY = -50;
  }
  update() {
    if (this.escaped) {
      this.y += (this.escapeY - this.y) * 0.01;
      this.x += Math.sin(this.phase) * 0.5;
      this.phase += this.pulseSpeed;
      return;
    }
    this.phase += this.pulseSpeed;
    this.wanderAngle += (Math.random() - 0.5) * 0.3;
    const wander = 0.15;
    this.vx += Math.cos(this.wanderAngle) * wander;
    this.vy += Math.sin(this.wanderAngle) * wander;
    // startled = fast erratic movement
    if (this.startled > 0) {
      this.vx += (Math.random() - 0.5) * 3;
      this.vy += (Math.random() - 0.5) * 3;
      this.startled -= 0.02;
    }
    // attract to cursor if inside jar and cursor near
    if (this.inJar) {
      const dx = mx - this.x, dy = my - this.y;
      const dist = Math.sqrt(dx*dx + dy*dy);
      if (dist < 150 && dist > 5) {
        this.vx += (dx / dist) * 0.08;
        this.vy += (dy / dist) * 0.08;
      }
    }
    this.vx *= 0.96; this.vy *= 0.96;
    const speed = Math.sqrt(this.vx*this.vx + this.vy*this.vy);
    if (speed > 3) { this.vx *= 3/speed; this.vy *= 3/speed; }
    this.x += this.vx; this.y += this.vy;
    if (this.inJar) this.constrainToJar();
  }
  constrainToJar() {
    const left = jarX - jarW/2 + 10, right = jarX + jarW/2 - 10;
    const top = jarY - jarH/2 + 30, bottom = jarY + jarH/2 - 10;
    // check lid escape
    if (lidOpen && this.y < top && Math.abs(this.x - jarX) < jarW * 0.25) {
      if (Math.random() < 0.002) {
        this.escaped = true;
        this.escapeY = -50 - Math.random() * 100;
        escapedFireflies.push(this);
        fireflies = fireflies.filter(f => f !== this);
        return;
      }
    }
    if (this.x < left) { this.x = left; this.vx *= -0.5; }
    if (this.x > right) { this.x = right; this.vx *= -0.5; }
    if (this.y < top) { this.y = top; this.vy *= -0.5; }
    if (this.y > bottom) { this.y = bottom; this.vy *= -0.5; }
  }
  draw() {
    const brightness = 0.4 + 0.6 * (0.5 + 0.5 * Math.sin(this.phase));
    const glowR = (8 + this.size * 3) * brightness;
    ctx.save();
    ctx.globalAlpha = brightness;
    const grad = ctx.createRadialGradient(this.x, this.y, 0, this.x, this.y, glowR);
    grad.addColorStop(0, this.color);
    grad.addColorStop(0.3, this.color + '88');
    grad.addColorStop(1, 'transparent');
    ctx.fillStyle = grad;
    ctx.beginPath();
    ctx.arc(this.x, this.y, glowR, 0, Math.PI * 2);
    ctx.fill();
    // core
    ctx.globalAlpha = brightness * 0.9;
    ctx.fillStyle = '#fff';
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.size * 0.4, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();
    // occasional particle
    if (Math.random() < 0.03 * brightness) {
      particles.push({ x: this.x, y: this.y, vx: (Math.random()-0.5)*0.5, vy: -Math.random()*0.5,
        life: 1, color: this.color, size: this.size * 0.3 });
    }
  }
}

function drawJar() {
  const sx = shakeOffset.x, sy = shakeOffset.y;
  ctx.save();
  ctx.translate(sx, sy);
  const x = jarX, y = jarY, w = jarW, h = jarH, r = jarR;
  const top = y - h/2, bot = y + h/2, left = x - w/2, right = x + w/2;
  // jar body â€” glass effect
  ctx.beginPath();
  ctx.moveTo(left + r, top + 20);
  ctx.lineTo(left, top + h * 0.15);
  ctx.quadraticCurveTo(left - 5, bot - r, left + r, bot);
  ctx.lineTo(right - r, bot);
  ctx.quadraticCurveTo(right + 5, bot - r, right, top + h * 0.15);
  ctx.lineTo(right - r, top + 20);
  ctx.strokeStyle = 'rgba(200,220,255,0.15)';
  ctx.lineWidth = 2;
  ctx.stroke();
  // glass highlight
  ctx.beginPath();
  ctx.moveTo(left + 8, top + h * 0.2);
  ctx.lineTo(left + 5, bot - 30);
  ctx.strokeStyle = 'rgba(200,220,255,0.08)';
  ctx.lineWidth = 3;
  ctx.stroke();
  // neck
  const neckW = w * 0.5;
  ctx.beginPath();
  ctx.moveTo(x - neckW/2, top + 20);
  ctx.lineTo(x - w/2 + r, top + 20);
  ctx.moveTo(x + neckW/2, top + 20);
  ctx.lineTo(x + w/2 - r, top + 20);
  ctx.strokeStyle = 'rgba(200,220,255,0.12)';
  ctx.lineWidth = 1.5;
  ctx.stroke();
  // lid
  if (!lidOpen) {
    ctx.fillStyle = 'rgba(120,100,80,0.4)';
    ctx.beginPath();
    ctx.ellipse(x, top + 15, neckW/2 + 5, 8, 0, 0, Math.PI * 2);
    ctx.fill();
    ctx.strokeStyle = 'rgba(160,140,110,0.3)';
    ctx.stroke();
  }
  // bottom rim
  ctx.beginPath();
  ctx.ellipse(x, bot - 2, w/2 - 5, 6, 0, 0, Math.PI * 2);
  ctx.strokeStyle = 'rgba(200,220,255,0.06)';
  ctx.lineWidth = 1;
  ctx.stroke();
  ctx.restore();
}

function drawGrass() {
  const bot = jarY + jarH/2 + shakeOffset.y;
  ctx.save();
  for (let i = 0; i < W; i += 8) {
    const h = 15 + Math.sin(i * 0.1 + Date.now() * 0.001) * 8;
    ctx.strokeStyle = `rgba(30,${60 + Math.random()*20},20,0.4)`;
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(i, H);
    ctx.quadraticCurveTo(i + Math.sin(Date.now()*0.002 + i)*3, H - h/2, i, H - h);
    ctx.stroke();
  }
  ctx.restore();
}

function drawStars() {
  if (!window._stars) {
    window._stars = [];
    for (let i = 0; i < 80; i++) {
      window._stars.push({ x: Math.random()*W, y: Math.random()*H*0.5, s: 0.5+Math.random()*1.5, p: Math.random()*Math.PI*2 });
    }
  }
  window._stars.forEach(s => {
    const b = 0.3 + 0.7 * (0.5 + 0.5 * Math.sin(s.p + Date.now() * 0.001));
    ctx.fillStyle = `rgba(255,255,255,${b * 0.4})`;
    ctx.beginPath();
    ctx.arc(s.x, s.y, s.s, 0, Math.PI * 2);
    ctx.fill();
  });
}

function addFireflies(n) {
  for (let i = 0; i < n; i++) {
    const x = jarX + (Math.random() - 0.5) * jarW * 0.6;
    const y = jarY + (Math.random() - 0.5) * jarH * 0.5;
    fireflies.push(new Firefly(x, y));
  }
  updateCount();
}

function toggleTap() {
  shakeDecay = 1;
  fireflies.forEach(f => { f.startled = 1; });
}

function toggleLid() {
  lidOpen = !lidOpen;
  document.getElementById('lidBtn').textContent = lidOpen ? 'ðŸ”“ lid open' : 'ðŸ”’ lid closed';
}

function cycleColor() {
  colorIdx = (colorIdx + 1) % colorSchemes.length;
  scheme = colorSchemes[colorIdx];
  fireflies.forEach(f => { f.color = scheme.colors[Math.floor(Math.random() * scheme.colors.length)]; });
  escapedFireflies.forEach(f => { f.color = scheme.colors[Math.floor(Math.random() * scheme.colors.length)]; });
  const names = ['ðŸŸ¡ warm','ðŸ”µ cool','ðŸŸ¢ firefly','ðŸŸ£ magic'];
  document.getElementById('colorBtn').textContent = names[colorIdx];
}

function updateCount() {
  document.getElementById('num').textContent = fireflies.length;
}

function updateParticles() {
  for (let i = particles.length - 1; i >= 0; i--) {
    const p = particles[i];
    p.x += p.vx; p.y += p.vy; p.life -= 0.02;
    if (p.life <= 0) { particles.splice(i, 1); continue; }
    ctx.globalAlpha = p.life * 0.5;
    ctx.fillStyle = p.color;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
    ctx.fill();
  }
  ctx.globalAlpha = 1;
}

function animate() {
  ctx.fillStyle = '#0a0a12';
  ctx.fillRect(0, 0, W, H);
  // shake
  if (shakeDecay > 0) {
    shakeOffset.x = (Math.random() - 0.5) * 8 * shakeDecay;
    shakeOffset.y = (Math.random() - 0.5) * 6 * shakeDecay;
    shakeDecay *= 0.94;
    if (shakeDecay < 0.01) { shakeDecay = 0; shakeOffset.x = 0; shakeOffset.y = 0; }
  }
  drawStars();
  drawGrass();
  // ambient jar glow
  const glowGrad = ctx.createRadialGradient(jarX, jarY, 0, jarX, jarY, jarH * 0.6);
  const gc = scheme.glow;
  glowGrad.addColorStop(0, gc + '08');
  glowGrad.addColorStop(0.5, gc + '03');
  glowGrad.addColorStop(1, 'transparent');
  ctx.fillStyle = glowGrad;
  ctx.fillRect(0, 0, W, H);
  drawJar();
  ctx.save();
  ctx.translate(shakeOffset.x, shakeOffset.y);
  fireflies.forEach(f => { f.update(); f.draw(); });
  ctx.restore();
  escapedFireflies.forEach(f => { f.update(); f.draw(); });
  updateParticles();
  requestAnimationFrame(animate);
}

// init
addFireflies(12);
animate();

// toast
const toast = document.getElementById('toast');
toast.style.opacity = 1;
setTimeout(() => { toast.style.opacity = 0; }, 3000);

// click to attract burst
canvas.addEventListener('click', () => {
  for (let i = 0; i < 3; i++) {
    particles.push({ x: mx, y: my, vx: (Math.random()-0.5)*2, vy: (Math.random()-0.5)*2,
      life: 1, color: scheme.glow, size: 1.5 });
  }
});
</script>
</body>
</html>